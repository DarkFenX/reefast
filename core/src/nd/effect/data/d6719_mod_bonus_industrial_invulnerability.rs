use itertools::chain;

use crate::{
    ac,
    ad::{AEffectBuff, AEffectBuffDuration, AEffectBuffFull, AEffectBuffScope, AEffectBuffStrength, AEffectId, AValue},
    ec,
    ed::EEffectId,
    nd::NEffect,
};

const EFFECT_EID: EEffectId = EEffectId::MOD_BONUS_INDUSTRIAL_INVULNERABILITY;
const EFFECT_AID: AEffectId = AEffectId::MOD_BONUS_INDUSTRIAL_INVULNERABILITY;

pub(in crate::nd::effect) fn mk_n_effect() -> NEffect {
    NEffect {
        eid: Some(EFFECT_EID),
        aid: EFFECT_AID,
        adg_buff: Some(AEffectBuff {
            full: chain(
                mk_buffs_for_scope(AEffectBuffScope::Carrier),
                mk_buffs_for_scope(AEffectBuffScope::Fleet(AItemListId::PANIC_ELIGIBLE)),
            )
            .collect(),
            ..
        }),
        ..
    }
}

fn mk_buffs_for_scope(scope: AEffectBuffScope) -> impl ExactSizeIterator<Item = AEffectBuffFull> {
    [
        // Buffs not specific to PANIC
        AEffectBuffFull {
            buff_id: ABuffId::WARP_PENALTY,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(100.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::DISALLOW_CLOAK,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(1.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::DISALLOW_TETHER,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(1.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        // PANIC-specific buffs
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_SHIELD_RESIST,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(-100.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_SHIELD_RECHARGE_TIME,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(-90.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_MASS_INCREASE,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(100.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_SCAN_RESOLUTION_PENALTY,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(-75.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_DRONE_DMG_PENALTY,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(-100.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_DISALLOW_WEAPONS,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(1.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
        AEffectBuffFull {
            buff_id: ABuffId::PANIC_DISALLOW_ENTOSIS,
            strength: AEffectBuffStrength::Hardcoded(AValue::from_f64(1.0)),
            duration: AEffectBuffDuration::AttrMs(AAttrId::BUFF_DURATION),
            scope,
        },
    ]
    .into_iter()
}
